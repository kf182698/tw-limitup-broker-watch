name: Daily Stock Watch (å°ç£æ™‚é–“ 18:00 åŸ·è¡Œ)

# è¨­å®šæ’ç¨‹
on:
  # cron è¨­å®š '0 10 * * 1-5'
  # UTC 10:00 å°æ‡‰å°ç£æ™‚é–“ (CST/GMT+8) 18:00ã€‚
  # åŸ·è¡Œæ™‚é–“ç‚ºæ¯é€±ä¸€åˆ°é€±äº”ï¼Œä»¥ç¬¦åˆäº¤æ˜“æ—¥éœ€æ±‚ã€‚
  schedule:
    - cron: '0 10 * * 1-5'
  
  # å…è¨±æ‰‹å‹•è§¸ç™¼ (æ–¹ä¾¿æ¸¬è©¦)
  workflow_dispatch:

jobs:
  run-daily-analysis:
    runs-on: ubuntu-latest
    
    steps:
      - name: æª¢æŸ¥ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: è¨­å®š Python ç’°å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: å®‰è£å°ˆæ¡ˆä¾è³´å¥—ä»¶
        run: pip install -r requirements.txt

      - name: åŸ·è¡Œæ¼²åœåˆ¸å•†ç›£æ§èˆ‡ Email é€šçŸ¥
        # å°‡æ‚¨åœ¨ Secrets ä¸­è¨­å®šçš„å¯†é‘°ï¼Œå®‰å…¨åœ°å‚³éç‚ºç’°å¢ƒè®Šæ•¸
        env:
          EMAIL_USERNAME: ${{ secrets.EMAIL_USERNAME }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          
        run: |
          # æ­¥é©Ÿ 1: è¨­å®šæ™‚å€ç‚º Asia/Taipei (å°ç£æ™‚é–“)
          export TZ='Asia/Taipei'
          
          # æ­¥é©Ÿ 2: ç²å–ä»Šå¤©çš„æ—¥æœŸ (YYYY-MM-DD) ä½œç‚ºç¨‹å¼åŸ·è¡Œçš„åƒæ•¸
          # é€™è£¡æœƒä½¿ç”¨ç•¶å‰ Runner æ™‚å€ä¸‹çš„æ—¥æœŸ (CST 18:00)
          TODAY_DATE=$(date +%Y-%m-%d)
          echo "å°ç£æ™‚é–“ $TODAY_DATE 18:00 é–‹å§‹åŸ·è¡Œ"
          
          # æ­¥é©Ÿ 3: åŸ·è¡Œæ‚¨çš„ Python è…³æœ¬
          python -m src.app.main run --date $TODAY_DATE
          
      - name: å°‡ç”Ÿæˆçš„è³‡æ–™çµæœæäº¤å›å„²å­˜åº« (Commit Data)
        # æ­¤æ­¥é©Ÿä¿®å¾©äº†ä¹‹å‰å› ç‚ºæ²’æœ‰æª”æ¡ˆè€Œå¤±æ•—çš„å•é¡Œ
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          # æ–°å¢ commit_options: '--allow-empty' ç¢ºä¿åœ¨æ²’æœ‰æª”æ¡ˆè®Šå‹•æ™‚ä¹Ÿèƒ½æˆåŠŸ
          commit_options: '--allow-empty' 
          # åªæäº¤æ•¸æ“šè³‡æ–™å¤¾å…§çš„æª”æ¡ˆè®Šå‹•
          file_pattern: 'data_raw/* data_clean/*'
          commit_message: "ğŸ¤– æ•¸æ“šè‡ªå‹•æäº¤ï¼šæ›´æ–°æ¯æ—¥ç›£æ§çµæœ"
