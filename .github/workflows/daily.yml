name: Daily Stock Watch (å°ç£æ™‚é–“ 18:00 åŸ·è¡Œ)

on:
  schedule:
    - cron: '0 10 * * 1-5'
  workflow_dispatch:

jobs:
  run-daily-analysis:
    runs-on: ubuntu-latest
    steps:
      - name: æª¢æŸ¥ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: è¨­å®š Python ç’°å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: å®‰è£å°ˆæ¡ˆä¾è³´å¥—ä»¶
        run: pip install -r requirements.txt

      - name: åŸ·è¡Œæ¼²åœåˆ¸å•†ç›£æ§èˆ‡ Email é€šçŸ¥
        env:
          EMAIL_USERNAME: ${{ secrets.EMAIL_USERNAME }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
        run: |
          # æ­¥é©Ÿ 1: è¨­å®šæ™‚å€ç‚º Asia/Taipei (å°ç£æ™‚é–“)
          export TZ='Asia/Taipei'
          # æ­¥é©Ÿ 2: ç²å–ä»Šå¤©çš„æ—¥æœŸ (YYY-MM-DD)
          TODAY_DATE=$(date +%Y-%m-%d)
          echo "å°ç£æ™‚é–“ $TODAY_DATE 18:00 é–‹å§‹åŸ·è¡Œ"
          # æ­¥é©Ÿ 3: åŸ·è¡Œæ‚¨çš„ Python è…³æœ¬
          python -m src.app.main run --date $TODAY_DATE

      - name: é©—è­‰æ•¸æ“šæ–‡ä»¶æ˜¯å¦ç”Ÿæˆ
        run: |
          echo "æª¢æŸ¥ data_raw ç›®éŒ„:"
          ls -la data_raw/ 2>/dev/null || echo "data_raw ä¸å­˜åœ¨æˆ–ç‚ºç©º"
          echo ""
          echo "æª¢æŸ¥ data_clean ç›®éŒ„:"
          ls -la data_clean/ 2>/dev/null || echo "data_clean ä¸å­˜åœ¨æˆ–ç‚ºç©º"
          echo ""
          echo "Git ç‹€æ…‹ï¼š"
          git status

      - name: å»ºç«‹ç©ºæª”æ¡ˆç¢ºä¿ç›®éŒ„å­˜åœ¨
        run: mkdir -p data_raw data_clean

      - name: å°‡ç”Ÿæˆçš„è³‡æ–™çµæœæäº¤å›å„²å­˜åº« (Commit Data)
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_options: '--allow-empty'
          file_pattern: 'data_raw/* data_clean/*'
          commit_message: "ğŸ¤– æ•¸æ“šè‡ªå‹•æäº¤ï¼šæ›´æ–°æ¯æ—¥ç›£æ§çµæœ"
          skip_dirty_check: true
